/*
CHAPTER 5: Using Subqueries  

	- Subsetting Data Using Subqueries
	- Creating and Managing Views Using PROC SQL
*/

LIBNAME certadv '/home/u45038867/certadv';

*Using a Single-Value Noncorrelated Subqueries;
PROC SQL;
	SELECT jobcode, avg(salary) as AvgSalary format=dollar11.2
		FROM certadv.payrollmaster
		group by jobcode
		HAVING AVG(salary)>
			(SELECT avg(salary)
				FROM certadv.payrollmaster
			);
QUIT;


*Using a conditional operator in a noncorrelated subquery;
PROC SQL;
	SELECT Empid, Firstname, lastname, city, state
		FROM certadv.staffmaster
		WHERE empid IN 
			(SELECT EmpId 
				FROM certadv.payrollmaster
				WHERE MONTH(DATEOFBIRTH)=2
			);
QUIT;


*Using the ANY Operator;
PROC SQL;
	SELECT empid, jobcode, dateofbirth
		FROM certadv.payrollmaster
		WHERE jobcode IN ('FA1', 'FA2') AND
			  dateofbirth > ANY (SELECT dateofbirth
			  						FROM certadv.payrollmaster
			  						WHERE jobcode='FA3'
			  					);
QUIT;


*Using the ALL Operator;
PROC SQL;
SELECT empid, jobcode, dateofbirth
		FROM certadv.payrollmaster
		WHERE jobcode IN ('FA1', 'FA2') AND
			  dateofbirth < ALL (SELECT dateofbirth
			  						FROM certadv.payrollmaster
			  						WHERE jobcode='FA3'
			  					);
QUIT;


*USing Correlated Subqueries;
PROC SQL;
	SELECT lastname, firstname
		FROM certadv.staffmaster
			WHERE 'NA' = 
				(SELECT jobcategory
 					FROM certadv.supervisors 
 					/*This is passed from the outer query*/
					WHERE staffmaster.empid = supervisors.empid);
QUIT;


*Using NOT EXISTS in a correlated subquery;
PROC SQL;
	SELECT lastname, firstname
		FROM certadv.flightattendants
			WHERE NOT EXISTS	
				(SELECT * 
					FROM certadv.flightschedule
					WHERE flightattendants.empid = flightschedule.empid);
QUIT;
